name: E2E Tests

on:
  workflow_call:

jobs:
  skip-e2e:
    name: Skip E2E
    runs-on: ubuntu-latest
    outputs:
      skip-e2e: ${{ steps.skip-e2e.outputs.SKIP_E2E}}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # By default, the checkout action checks out the last merge commit for pull requests.
          # Source: https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows#pull_request
          # However, we need the head commit (the latest commit pushed to the source branch)
          # because in the workflow, we would like to parse the latest commit.
          # Specifying `ref` ensures that the head commit is checked out directly.
          # For a `pull_request` event, the head commit hash is `github.event.pull_request.head.sha`.
          # For a `push` event, the head commit hash is `github.sha`.
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Skip E2E
        id: skip-e2e
        env:
          HEAD_COMMIT_HASH: ${{ github.event.pull_request.head.sha || github.sha }}
        run: |
          if git show --format='%B' --no-patch "${HEAD_COMMIT_HASH}" | grep --fixed-strings --quiet '[skip e2e]'; then
              printf '%s\n' "${HEAD_COMMIT_HASH} contains the tag '[skip e2e]' so e2e tests will not run"
              echo "SKIP_E2E=true" >> "$GITHUB_OUTPUT"
          else
              printf '%s\n' "${HEAD_COMMIT_HASH} does not contain the tag '[skip e2e]' so e2e tests will run"
              echo "SKIP_E2E=false" >> "$GITHUB_OUTPUT"
          fi

  get-changed-files-with-git-diff:
    needs:
      - skip-e2e
    runs-on: ubuntu-latest
    if: ${{ github.ref != 'refs/heads/master' && !needs.skip-e2e.outputs.skip-e2e }}
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout and setup environment
        uses: metamask/github-tools/.github/actions/checkout-and-setup@1299bb1de0c6974ae6d0a32c7e8897fe168239ac
        with:
          is-high-risk-environment: false

      - name: Get changed files with git diff
        run: yarn git-diff-default-branch:github

      - name: Upload changed files artifact
        uses: actions/upload-artifact@v4
        with:
          name: changed-files
          path: ./changed-files/

  prep-build-test:
    needs:
      - skip-e2e
    if: ${{ !needs.skip-e2e.outputs.skip-e2e }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout and setup environment
        uses: metamask/github-tools/.github/actions/checkout-and-setup@1299bb1de0c6974ae6d0a32c7e8897fe168239ac
        with:
          is-high-risk-environment: false

      - run: yarn build:test

      - name: Upload dist
        uses: actions/upload-artifact@v4
        with:
          name: dist-e2e-tests
          path: ./dist/

  prep-build-test-flask:
    needs:
      - skip-e2e
    if: ${{ !needs.skip-e2e.outputs.skip-e2e }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout and setup environment
        uses: metamask/github-tools/.github/actions/checkout-and-setup@1299bb1de0c6974ae6d0a32c7e8897fe168239ac
        with:
          is-high-risk-environment: false

      - run: yarn build:test:flask

      - name: Upload dist
        uses: actions/upload-artifact@v4
        with:
          name: dist-e2e-tests-flask
          path: ./dist/

  prep-build-test-mv2:
    needs:
      - skip-e2e
    if: ${{ !needs.skip-e2e.outputs.skip-e2e }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout and setup environment
        uses: metamask/github-tools/.github/actions/checkout-and-setup@1299bb1de0c6974ae6d0a32c7e8897fe168239ac
        with:
          is-high-risk-environment: false

      - run: yarn build:test:mv2

      - name: Upload dist
        uses: actions/upload-artifact@v4
        with:
          name: dist-e2e-tests-mv2
          path: ./dist/

  prep-build-test-flask-mv2:
    needs:
      - skip-e2e
    if: ${{ !needs.skip-e2e.outputs.skip-e2e }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout and setup environment
        uses: metamask/github-tools/.github/actions/checkout-and-setup@1299bb1de0c6974ae6d0a32c7e8897fe168239ac
        with:
          is-high-risk-environment: false

      - run: yarn build:test:flask:mv2

      - name: Upload dist
        uses: actions/upload-artifact@v4
        with:
          name: dist-e2e-tests-flask-mv2
          path: ./dist/

  test-e2e-chrome:
    needs:
      - skip-e2e
      - get-changed-files-with-git-diff
      - prep-build-test
    if: ${{ !needs.skip-e2e.outputs.skip-e2e }}
    runs-on: ubuntu-22.04
    container:
      image: cimg/node:22.13-browsers
    strategy:
      fail-fast: false
      matrix:
        index:
          [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]
    env:
      MATRIX_INDEX: ${{ matrix.index }}
      MATRIX_TOTAL: ${{ strategy.job-total }}
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install zstd
          sudo corepack enable
        shell: bash

      - name: Checkout and setup environment
        uses: metamask/github-tools/.github/actions/checkout-and-setup@1299bb1de0c6974ae6d0a32c7e8897fe168239ac
        with:
          is-high-risk-environment: false

      - name: Install anvil (not installed by checkout-and-setup when cache is restored)
        run: yarn foundryup

      - name: Download prep-build-test artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-e2e-tests
          path: ./dist/

      - name: Configure Xvfb
        run: Xvfb -ac :99 -screen 0 1280x1024x16 &

      - name: Download changed-files artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: changed-files
          path: ./changed-files/

      - name: Run e2e tests
        timeout-minutes: 30
        run: yarn test:e2e:chrome

      - name: Upload test results and artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-e2e-chrome-${{ matrix.index }}
          path: |
            ./test-artifacts
            ./test/test-results/e2e

  test-e2e-chrome-flask:
    needs:
      - skip-e2e
      - prep-build-test-flask
      - get-changed-files-with-git-diff
    if: ${{ !needs.skip-e2e.outputs.skip-e2e }}
    runs-on: ubuntu-22.04
    container:
      image: cimg/node:22.13-browsers
    strategy:
      fail-fast: false
      matrix:
        index: [0, 1, 2, 3, 4, 5, 6, 7]
    env:
      MATRIX_INDEX: ${{ matrix.index }}
      MATRIX_TOTAL: ${{ strategy.job-total }}
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install zstd
          sudo corepack enable
        shell: bash

      - name: Checkout and setup environment
        uses: metamask/github-tools/.github/actions/checkout-and-setup@1299bb1de0c6974ae6d0a32c7e8897fe168239ac
        with:
          is-high-risk-environment: false

      - name: Install anvil (not installed by checkout-and-setup when cache is restored)
        run: yarn foundryup

      - name: Download prep-build-test-flask artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-e2e-tests-flask
          path: ./dist/

      - name: Configure Xvfb
        run: Xvfb -ac :99 -screen 0 1280x1024x16 &

      - name: Download changed-files artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: changed-files
          path: ./changed-files/

      - name: Run e2e tests
        timeout-minutes: 30
        run: yarn test:e2e:chrome:flask

      - name: Upload test results and artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-e2e-chrome-flask-${{ matrix.index }}
          path: |
            ./test-artifacts
            ./test/test-results/e2e

  test-e2e-chrome-multiple-providers:
    needs:
      - skip-e2e
      - prep-build-test
      - get-changed-files-with-git-diff
    if: ${{ !needs.skip-e2e.outputs.skip-e2e }}
    runs-on: ubuntu-22.04
    container:
      image: cimg/node:22.13-browsers
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install zstd
          sudo corepack enable
        shell: bash

      - name: Checkout and setup environment
        uses: metamask/github-tools/.github/actions/checkout-and-setup@1299bb1de0c6974ae6d0a32c7e8897fe168239ac
        with:
          is-high-risk-environment: false

      - name: Install anvil (not installed by checkout-and-setup when cache is restored)
        run: yarn foundryup

      - name: Download prep-build-test artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-e2e-tests
          path: ./dist/

      - name: Configure Xvfb
        run: Xvfb -ac :99 -screen 0 1280x1024x16 &

      - name: Download changed-files artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: changed-files
          path: ./changed-files/

      - name: Run e2e tests
        timeout-minutes: 30
        run: yarn test:e2e:chrome:multi-provider

      - name: Upload test results and artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-e2e-chrome-multiple-providers
          path: |
            ./test-artifacts
            ./test/test-results/e2e

  test-e2e-chrome-rpc:
    needs:
      - skip-e2e
      - prep-build-test
      - get-changed-files-with-git-diff
    if: ${{ !needs.skip-e2e.outputs.skip-e2e }}
    runs-on: ubuntu-22.04
    container:
      image: cimg/node:22.13-browsers
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install zstd
          sudo corepack enable
        shell: bash

      - name: Checkout and setup environment
        uses: metamask/github-tools/.github/actions/checkout-and-setup@1299bb1de0c6974ae6d0a32c7e8897fe168239ac
        with:
          is-high-risk-environment: false

      - name: Install anvil (not installed by checkout-and-setup when cache is restored)
        run: yarn foundryup

      - name: Download prep-build-test artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-e2e-tests
          path: ./dist/

      - name: Configure Xvfb
        run: Xvfb -ac :99 -screen 0 1280x1024x16 &

      - name: Download changed-files artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: changed-files
          path: ./changed-files/

      - name: Run e2e tests
        timeout-minutes: 30
        run: yarn test:e2e:chrome:rpc

      - name: Upload test results and artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-e2e-chrome-rpc
          path: |
            ./test-artifacts
            ./test/test-results/e2e

  test-e2e-firefox:
    needs:
      - skip-e2e
      - prep-build-test-mv2
      - get-changed-files-with-git-diff
    if: ${{ !needs.skip-e2e.outputs.skip-e2e }}
    runs-on: ubuntu-22.04
    container:
      image: cimg/node:22.13-browsers
    strategy:
      fail-fast: false
      matrix:
        index:
          [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]
    env:
      MATRIX_INDEX: ${{ matrix.index }}
      MATRIX_TOTAL: ${{ strategy.job-total }}
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install zstd
          sudo corepack enable
        shell: bash

      - name: Checkout and setup environment
        uses: metamask/github-tools/.github/actions/checkout-and-setup@1299bb1de0c6974ae6d0a32c7e8897fe168239ac
        with:
          is-high-risk-environment: false

      - name: Install anvil (not installed by checkout-and-setup when cache is restored)
        run: yarn foundryup

      - name: Download prep-build-test-mv2 artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-e2e-tests-mv2
          path: ./dist/

      - name: Configure Xvfb
        run: Xvfb -ac :99 -screen 0 1280x1024x16 &

      - name: Download changed-files artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: changed-files
          path: ./changed-files/

      - name: Run e2e tests
        timeout-minutes: 30
        run: yarn test:e2e:firefox

      - name: Upload test results and artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-e2e-firefox-${{ matrix.index }}
          path: |
            ./test-artifacts
            ./test/test-results/e2e

  test-e2e-firefox-flask:
    needs:
      - skip-e2e
      - prep-build-test-flask-mv2
      - get-changed-files-with-git-diff
    if: ${{ !needs.skip-e2e.outputs.skip-e2e }}
    runs-on: ubuntu-22.04
    container:
      image: cimg/node:22.13-browsers
    strategy:
      fail-fast: false
      matrix:
        index: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
    env:
      MATRIX_INDEX: ${{ matrix.index }}
      MATRIX_TOTAL: ${{ strategy.job-total }}
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install zstd
          sudo corepack enable
        shell: bash

      - name: Checkout and setup environment
        uses: metamask/github-tools/.github/actions/checkout-and-setup@1299bb1de0c6974ae6d0a32c7e8897fe168239ac
        with:
          is-high-risk-environment: false

      - name: Install anvil (not installed by checkout-and-setup when cache is restored)
        run: yarn foundryup

      - name: Download prep-build-test-flask-mv2 artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-e2e-tests-flask-mv2
          path: ./dist/

      - name: Configure Xvfb
        run: Xvfb -ac :99 -screen 0 1280x1024x16 &

      - name: Download changed-files artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: changed-files
          path: ./changed-files/

      - name: Run e2e tests
        timeout-minutes: 30
        run: yarn test:e2e:firefox:flask

      - name: Upload test results and artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-e2e-firefox-flask-${{ matrix.index }}
          path: |
            ./test-artifacts
            ./test/test-results/e2e

  prep-build-mv2:
    needs:
      - skip-e2e
    if: ${{ !needs.skip-e2e.outputs.skip-e2e }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout and setup environment
        uses: metamask/github-tools/.github/actions/checkout-and-setup@1299bb1de0c6974ae6d0a32c7e8897fe168239ac
        with:
          is-high-risk-environment: false

      - run: ENABLE_MV3=false yarn build dist

      - name: Upload dist
        uses: actions/upload-artifact@v4
        with:
          name: dist-mv2
          path: ./dist/

  test-mozilla-lint-mv2:
    needs:
      - skip-e2e
      - prep-build-mv2
      - get-changed-files-with-git-diff
    if: ${{ !needs.skip-e2e.outputs.skip-e2e }}
    runs-on: ubuntu-22.04
    container:
      image: cimg/node:22.13-browsers
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install zstd
          sudo corepack enable
        shell: bash

      - name: Checkout and setup environment
        uses: metamask/github-tools/.github/actions/checkout-and-setup@1299bb1de0c6974ae6d0a32c7e8897fe168239ac
        with:
          is-high-risk-environment: false

      - name: Download prep-build-mv2 artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-mv2
          path: ./dist/

      - name: Download changed-files artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: changed-files
          path: ./changed-files/

      - name: test:mozilla-lint
        run: yarn mozilla-lint

      - name: Upload test results and artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-mozilla-lint-mv2
          path: ./test-artifacts

  validate-source-maps-mv2:
    needs:
      - skip-e2e
      - prep-build-mv2
      - get-changed-files-with-git-diff
    if: ${{ !needs.skip-e2e.outputs.skip-e2e }}
    runs-on: ubuntu-22.04
    container:
      image: cimg/node:22.13-browsers
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install zstd
          sudo corepack enable
        shell: bash

      - name: Checkout and setup environment
        uses: metamask/github-tools/.github/actions/checkout-and-setup@1299bb1de0c6974ae6d0a32c7e8897fe168239ac
        with:
          is-high-risk-environment: false

      - name: Download prep-build-mv2 artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-mv2
          path: ./dist/

      - name: Download changed-files artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: changed-files
          path: ./changed-files/

      - name: Validate source maps
        run: yarn validate-source-maps

      - name: Upload validation artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: source-maps-validation-mv2
          path: ./validation-artifacts
